{{- if .Values.posthog.proxy.enabled }}
---
# PostHog Service (headless, using manual Endpoints)
# Routes analytics requests through our domain to bypass content blockers
# Note: Can't use ExternalName as Traefik has it disabled by default
apiVersion: v1
kind: Service
metadata:
  name: {{ include "resume.fullname" . }}-posthog-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: https
      port: 443
      targetPort: 443
---
# Manual Endpoints pointing to PostHog IPs
# These IPs are for us-proxy-direct.i.posthog.com (resolve dynamically if needed)
apiVersion: v1
kind: Endpoints
metadata:
  name: {{ include "resume.fullname" . }}-posthog-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
subsets:
  - addresses:
      {{- range .Values.posthog.proxy.ips }}
      - ip: {{ . | quote }}
      {{- end }}
    ports:
      - name: https
        port: 443
---
# Strip /ingest prefix middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: {{ include "resume.fullname" . }}-posthog-stripprefix
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
spec:
  stripPrefix:
    prefixes:
      - /ingest
---
# Set Host header for PostHog
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: {{ include "resume.fullname" . }}-posthog-headers
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
spec:
  headers:
    customRequestHeaders:
      Host: {{ .Values.posthog.proxy.host }}
---
# ServersTransport for TLS to PostHog
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: {{ include "resume.fullname" . }}-posthog-transport
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
spec:
  serverName: {{ .Values.posthog.proxy.host }}
  # Skip TLS verification for external service (PostHog uses valid certs, but Traefik may lack CA bundle)
  insecureSkipVerify: true
---
# PostHog proxy IngressRoute
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ include "resume.fullname" . }}-posthog-proxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
spec:
  entryPoints:
    - {{ .Values.ingress.entryPoint | default "websecure" }}
  routes:
    - match: Host(`{{ .Values.ingress.frontendHost }}`) && PathPrefix(`/ingest`)
      kind: Rule
      middlewares:
        - name: {{ include "resume.fullname" . }}-posthog-stripprefix
        - name: {{ include "resume.fullname" . }}-posthog-headers
      services:
        - name: {{ include "resume.fullname" . }}-posthog-external
          port: 443
          scheme: https
          serversTransport: {{ .Release.Namespace }}-{{ include "resume.fullname" . }}-posthog-transport@kubernetescrd
      priority: 200
  {{- if .Values.ingress.tls.enabled }}
  tls:
    secretName: {{ .Values.ingress.tls.frontendSecretName }}
  {{- end }}
{{- end }}
