{{- if .Values.systemPrompt.content }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "resume.fullname" . }}-init-system-prompt
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "resume.labels" . | nindent 4 }}
  annotations:
    # Run this job on install and upgrade
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "1"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "resume.labels" . | nindent 8 }}
        app.kubernetes.io/component: init-job
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: init-system-prompt
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Only write the file if it doesn't exist
              if [ ! -f /data/system_prompt.txt ]; then
                echo "Initializing system_prompt.txt..."
                cat > /data/system_prompt.txt << 'EOF'
{{ .Values.systemPrompt.content | indent 16 }}
              EOF
                echo "System prompt initialized successfully"
              else
                echo "system_prompt.txt already exists, skipping initialization"
              fi
          volumeMounts:
            - name: system-prompt
              mountPath: /data
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: system-prompt
          persistentVolumeClaim:
            claimName: {{ include "resume.fullname" . }}-system-prompt
{{- end }}
