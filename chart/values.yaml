# Resume Helm Chart Values

# Backend configuration
backend:
  image:
    repository: registry.local.k3s.cmoore.io:8443/resume/backend
    tag: "v1.0.32"
    pullPolicy: IfNotPresent

  replicaCount: 1

  service:
    # Use LoadBalancer for direct access (optional), or ClusterIP for ingress-only
    type: ClusterIP
    port: 8080
    targetPort: 8080
    # LoadBalancer configuration (only used if type: LoadBalancer)
    loadBalancerIP: "192.168.64.115"
    annotations:
      kube-vip.io/loadbalancerIPs: "192.168.64.115"
      svccontroller.k3s.cattle.io/enablelb: "false"

  # Environment variables
  env:
    openaiModel: "gpt-4o-realtime-preview-2024-12-17"
    port: "8080"
    # GPT Realtime mode (local pipeline disabled)
    useLocalPipeline: "false"

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Health probes
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  # TTS sidecar container (for local pipeline mode)
  # DEPRECATED: Now using external TTS service at https://llama.k3s.local.christianmoore.me:8443
  tts:
    enabled: false
    image:
      repository: ghcr.io/matatonic/openedai-speech
      tag: "latest"
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    storage:
      size: 10Gi
      # Leave empty to use default storage class
      storageClass: ""

# Frontend configuration
frontend:
  image:
    repository: registry.local.k3s.cmoore.io:8443/resume/frontend
    tag: "v1.0.36"
    pullPolicy: IfNotPresent

  replicaCount: 1

  service:
    type: ClusterIP
    port: 80
    targetPort: 80

  # Environment variables for runtime configuration
  env:
    # WebSocket URL - must use wss:// for secure connection
    wsUrl: "wss://christianmoore.me/ws/chat"
    # API URL (optional, for future REST endpoints)
    apiUrl: "https://christianmoore.me"
    # PostHog analytics (optional)
    # Using proxied endpoint to bypass content blockers
    posthogKey: "phc_8VCGVxP0ckbL20XuspX70VjOfqxjg40O6IdOMaPS0A5"
    posthogHost: "https://christianmoore.me/ingest"

  # Resource limits
  resources:
    requests:
      cpu: 25m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Health probes
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  # Frontend-specific security context (nginx runs as UID 101)
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    runAsGroup: 101
    fsGroup: 101
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    runAsNonRoot: true
    runAsUser: 101
    seccompProfile:
      type: RuntimeDefault

# Ingress configuration (Traefik IngressRoute)
ingress:
  enabled: true
  # Primary frontend domain
  frontendHost: christianmoore.me
  # Backend API domain (optional - can access backend via frontendHost/ws/ and /api/)
  backendHost: backend.christianmoore.me
  backendEnabled: true  # Set to false to disable separate backend domain
  entryPoint: websecure  # Standard HTTPS on port 443 (externally exposed)
  tls:
    enabled: true
    frontendSecretName: resume-frontend-tls
    backendSecretName: resume-backend-tls
  certIssuer: letsencrypt-cloudflare  # DNS-01 challenge for external services

# PostHog analytics proxy configuration
# Proxies PostHog requests through our domain to bypass content blockers
# Requires Traefik arg: --providers.kubernetescrd.allowexternalnameservices=true
posthog:
  proxy:
    enabled: true
    # PostHog ingestion host (use region-specific proxy host)
    host: us-proxy-direct.i.posthog.com

# Rate limiting configuration
rateLimit:
  enabled: true
  # Backend API rate limits (applies to /ws/, /api/, /health endpoints)
  backend:
    # Average requests per second (human chat: 1 WebSocket connection + occasional refreshes)
    average: 2
    # Maximum burst size (allows page refreshes and retries)
    burst: 5
    # Period for rate calculation
    period: 1m
  # Frontend rate limits (static assets: HTML, CSS, JS, fonts)
  frontend:
    # Average requests per second (initial page load ~5-10 assets)
    average: 20
    # Maximum burst size (allows quick successive asset loads)
    burst: 40
    period: 1m

# Secrets - populated from external secret or manually created
# These should be created separately via kubectl or sealed-secrets
secrets:
  # Use SealedSecret (recommended for GitOps)
  useSealed: false
  # Required secrets - must be set externally
  # The secret must contain the following keys:
  #   - openai-api-key: OpenAI API key (e.g., sk-...)
  #   - jwt-secret: Secret for signing JWT tokens (random string, e.g., generate with: openssl rand -base64 32)
  #   - turnstile-secret: Cloudflare Turnstile secret key (from Cloudflare dashboard)
  #   - turnstile-site-key: Cloudflare Turnstile site key (from Cloudflare dashboard)
  #
  # Option 1 - Manual secret:
  #   kubectl create secret generic resume-secrets \
  #     --from-literal=openai-api-key=sk-... \
  #     --from-literal=jwt-secret=$(openssl rand -base64 32) \
  #     --from-literal=turnstile-secret=0x... \
  #     --from-literal=turnstile-site-key=0x...
  #
  # Option 2 - SealedSecret (recommended):
  #   See chart/templates/sealedsecret.yaml.example
  existingSecret: resume-secrets

# System prompt configuration
systemPrompt:
  # System prompt content stored in ConfigMap (no persistent storage needed)
  content: |
    You are a virtual assistant with knowledge about Christian Moore (adult male from New Hampshire, USA) — Cloud Infrastructure Architect with 10+ years designing production-scale platforms across cloud and on-premise environments.
    Expert in container orchestration, GitOps, Linux systems, web technology, and security hardening.
    He builds platforms for security, performance, scalability, high availability, and cost optimization. Deep expertise in AWS-native architectures, observability, Infrastructure as Code, and networking.
    Specialized in HPC workloads, platform engineering, and production SRE with hands-on experience running enterprise compute clusters and distributed Kubernetes.
    He has a big family - mom, dad, two sisters one older, one younger, two nephews, and a niece. Also 2 cats, Tanner and Taffy.

    Purpose
    - Your sole job is to answer questions ABOUT Christian and his field — background, skills, projects, and hobbies — using ONLY profile facts in this system message.

    Scope & intent
    - Prioritize factual, first-person answers about Christian's roles, achievements, tooling, domains, portfolios, and outcomes.
    - If a question requires speculation or isn't covered by the profile, say you don't have that information.
    - Respect privacy: share only contact methods or links present in the provided profile.

    Voice & style
    - Professional, friendly, concise, precise. Give direct answers in 1-3 sentences. Avoid long responses.
    - Avoid hype/clichés; prefer concrete verbs (designed, implemented, operated).
    - Use absolute dates (e.g., "February 2021-Present") and specific tools/versions when available.

    Truth constraints
    - Never invent employers, dates, credentials, hobbies, or project claims.

    Work history you may cite
    - Cloud Solutions Architect — Amazon (Ring/Blink), 2021 to Present
    - Cloud Security Engineer — Cimpress, 2017 to 2020
    - DevOps Engineer — Cimpress, 2014 to 2017
    - Problem Manager — Vistaprint, 2010 to 2013
    - SysAdmin — Vistaprint, 2007 to 2009

    Expertise you may cite
    - Containers/GitOps: Kubernetes/k3s, EKS, ECS, ArgoCD, Helm, Docker, Pod Security, Secrets Management
    - IaC & Automation: Terraform, AWS CDK, Ansible, CI/CD (GitHub Actions, GitLab, Jenkins)
    - Observability: CloudWatch, Grafana, Prometheus, OpenSearch, Fluent Bit
    - Security/Networking: Zero-trust, TLS/SSL, IAM/KMS, GuardDuty/CloudTrail, ALB/NLB, Route 53, PrivateLink
    - Storage/Data: EBS, EFS, FSx, ZFS, S3, Longhorn
    - HPC/EDA Admin: Slurm, Synopsys, License management
    - Languages/OS: Python, Bash, JavaScript; Linux (RHEL/Ubuntu/Amazon), Windows, macOS
    - Leadership: Mentoring, cross-functional collaboration, incident response, capacity planning

    Personal interests you may cite
    - Cars: he owns a 2012 GT500 and 2017 F-150
    - Movies: he has a large 4K bluray collection
    - Homelab: he has a large Raspberry Pi & AI k3s cluster

    Interaction model
    - Focus on "about Christian" questions, but also answer general questions about his areas of expertise

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  runAsUser: 1000
  seccompProfile:
    type: RuntimeDefault

# Deployment strategy
# Note: Backend uses Recreate because it mounts a ReadWriteOnce PVC
# which can only be attached to one pod at a time
strategy:
  type: Recreate

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity: {}
